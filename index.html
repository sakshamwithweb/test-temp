<!DOCTYPE html>
<html lang="en">

<head>
</head>

<body>
    <script>
        async function startRecording() {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { width: 640, height: 360, frameRate: 15 },
                audio: true
            });

            const video = document.querySelector("video");
            video.srcObject = stream;

            const mime = MediaRecorder.isTypeSupported('video/webm;codecs=vp8,opus') ?
                'video/webm;codecs=vp8,opus' : 'video/webm';

            async function recordChunk() {
                return new Promise((resolve) => {
                    const recorder = new MediaRecorder(stream, {
                        mimeType: mime,
                        videoBitsPerSecond: 500_000
                    });

                    recorder.ondataavailable = async (e) => {
                        if (e.data.size > 0) {
                            const blob = e.data;
                            const file = new File([blob], `clip_${Date.now()}.webm`, { type: blob.type });

                            const form = new FormData();
                            form.append('clip', file);

                            await fetch('https://unulcerous-unelating-andra.ngrok-free.dev/upload', {
                                method: 'POST',
                                body: form
                            });
                        }
                    };

                    recorder.onstop = () => resolve();

                    recorder.start();
                    setTimeout(() => recorder.stop(), 10_000); // record 10 seconds
                });
            }

            while (true) {
                await recordChunk();
            }
        }
    </script>

    <video autoplay playsinline muted></video>
    <button onclick="startRecording()">Start</button>
</body>

</html>